#!/bin/sh

file=$1

tmp_dir=/tmp
tmp_dir_file_prefix=dots-backup

data_backup=${tmp_dir}/${tmp_dir_file_prefix}-data
gpg_backup=${tmp_dir}/${tmp_dir_file_prefix}-gpg
key_backup=${tmp_dir}/${tmp_dir_file_prefix}-key
db_backup=${tmp_dir}/${tmp_dir_file_prefix}-db

backup_files=(
  ${data_backup}
  ${gpg_backup}
  ${key_backup}
  ${db_backup}
)

if [ -z ${file} ]; then 
  echo "Please specify backup file!"
  exit 0
fi 

gpg --decrypt ${file} |
  tar xfzP - 

echo "Restore of backup complete!"

gpg --import ${gpg_backup}
gpg --import ${key_backup} 
gpg --import-ownertrust ${db_backup}

echo "Extracting personal data..."
gpg --decrypt ${data_backup} |
  tar zfxP - ${HOME}

echo "Extring system-wide data.."
gpg --decrypt ${data_backup} |
  sudo tar zxP --exclude ${HOME} --file -  

rm -rf ${backup_files[@]}

echo "Backup successfully restored!"
echo -e "Bussi, baba\n"
