#!/bin/zsh

set -x

scriptPath=$(realpath "$0") 
repoPath="$(dirname ${scriptPath})/../../.."

unlinkFiles() {
	destDir=${2}
	prefix=${3} # used for sudo 
	normalized=''
	fileOperation="trash" 

	# if sudo is used use rm instead of trash 
	# otherwise it will be trashed to roots bin
	if [ "${prefix}" = "sudo" ]; then 
		fileOperation="rm -f" 
	fi 

	# if destination is home directory normalize 
	# path of parent folder
	if [[ "${2}" = ${HOME}* ]]; then
		normalized=${1}/
	fi 

	for file in ${repoPath}/${1}/**/*; do 
		file=$(realpath --relative-base=${repoPath} $file)

		if [ -f ${repoPath}/${file} ]; then 
			${prefix} ${fileOperation} ${destDir}${file#"${normalized}"}
		fi 
	done 

	# if folder is empty after removing all symlinks 
	# also drop the whole folder. 
	# we also scan directories in opposite order to remove 
	# nested empty directories 
	for file in $(ls -trt -d -1 ${repoPath}/${1}/**/*); do 
		file=$(realpath --relative-base=${repoPath} $file)

		if [ -d ${repoPath}/${file} ]; then 
			folderPath=${destDir}${file#"$normalized"}

			if [ $(ls -A "$folderPath" | wc -l) -eq 0 ]; then 
				${prefix} ${fileOperation} ${folderPath}
			fi
		fi 
	done
}

setopt dotglob

unlinkFiles home ${HOME}/
unlinkFiles etc  /        sudo

unsetopt dotglob
