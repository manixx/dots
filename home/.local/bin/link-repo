#!/bin/zsh

scriptPath=$(realpath "$0")
repoPath="$(dirname ${scriptPath})/../../.."

linkFiles() {
	destDir=${2}
	prefix=${3} # used for sudo
	normalized=''

	# if destination is home directory normalize
	# path of parent folder
	if [[ "${2}" = ${HOME}* ]]; then
		normalized=${1}/
	fi

	for file in ${repoPath}/${1}/**/*; do
		file=$(realpath --relative-base=${repoPath} $file)

		if [ -d ${repoPath}/${file} ]; then
			${prefix} mkdir -p ${destDir}${file#"$normalized"}
		fi

		if [ -f ${repoPath}/${file} ]; then
			if [ -z ${prefix} ]; then
				ln -sf ${repoPath}/${file} -t ${destDir}$(dirname ${file#"${normalized}"})
			else
				${prefix} cp -if --remove-destination ${repoPath}/${file} ${destDir}$(dirname ${file#"${normalized}"})
			fi
		fi
	done
}

setopt dotglob # include dot files

linkFiles home ${HOME}/
if read -q "REPLY?Also copy /?"; then
	linkFiles etc / sudo
fi

unsetopt dotglob
